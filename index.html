<!doctype html> 
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Info Board</title>

<style>
    /* ✅ FULLSCREEN BUTTON (más pequeño, sin texto, discreto en fullscreen) */
    .fsbtn{
      width:36px;
      height:36px;
      padding:0;
      display:grid;
      place-items:center;

      background:#0c0c0c;
      color:#f2f2f2;
      border:1px solid #2b2b2b;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      line-height:1;
      font-size:16px;
    }
    .fsbtn:hover{ border-color:#555; }
    .fsbtn:focus-visible{
      outline:2px solid #666;
      outline-offset:2px;
    }

    /* ✅ En fullscreen: más discreto y flotante (esquina) */
    body.is-fs .fsbtn{
      position:fixed;
      top:10px;
      right:10px;
      z-index:10001;

      opacity:.28;
      background:transparent;
      border-color:transparent;
    }
    body.is-fs .fsbtn:hover,
    body.is-fs .fsbtn:focus-visible{
      opacity:.75;
      background:#0c0c0c;
      border-color:#2b2b2b;
    }

:root{
--panel:#111;
--grid:#2a2a2a;
--text:#f2f2f2;
--yellow:#ffd400;
--muted:#b8b8b8;
--danger:#ff5c5c;
--warn:#ffcc66;
--ok:#7CFF7C;
}
*{ box-sizing:border-box; }
body{
margin:0;
background:linear-gradient(180deg,#0a0a0a,#000);
color:var(--text);
font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}
.wrap{
max-width: 1400px;
margin: 24px auto;
padding: 0 16px;
}
.header{
display:flex;
align-items:center;
justify-content:space-between;
padding: 16px 18px;
background: linear-gradient(180deg,#1b1b1b,#0f0f0f);
border: 1px solid #2b2b2b;
border-radius: 14px 14px 0 0;
}
.title{
display:flex;
gap:12px;
align-items:center;
font-weight:800;
letter-spacing:0.08em;
}
.badge{
width:34px;height:34px;
border-radius:8px;
background:var(--yellow);
display:grid;place-items:center;
color:#000;font-weight:900;
}
.meta{
text-align:right;
font-size: 12px;
color: var(--muted);
line-height:1.4;
}

.board{
background: var(--panel);
border: 1px solid #2b2b2b;
overflow:hidden;
border-radius: 14px;
}
.board.first{
border-top:0;
border-radius: 0 0 14px 14px;
}
.board + .board{ margin-top: 14px; }

.sectionTitle{
padding: 12px 16px;
background:#0e0e0e;
border-bottom:1px solid #2b2b2b;
font-size: 13px;
letter-spacing:0.14em;
text-transform:uppercase;
color:#cfcfcf;
font-weight:700;
}

table{
width:100%;
border-collapse:collapse;
font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
font-size: 18px;
letter-spacing:0.04em;
}
table.compact{ font-size: 16px; }

thead th{
text-align:left;
padding: 12px 16px;
background: #0c0c0c;
color:#cfcfcf;
border-bottom:1px solid #2b2b2b;
font-size: 13px;
letter-spacing:0.12em;
text-transform:uppercase;
white-space:nowrap;
}
tbody td{
padding: 10px 16px;
border-bottom: 1px solid var(--grid);
color: var(--yellow);
white-space:nowrap;
}
tbody tr:last-child td{ border-bottom:0; }

.status{
padding: 4px 10px;
border-radius: 999px;
font-size: 13px;
letter-spacing:0.08em;
display:inline-block;
border:1px solid #333;
background:#0c0c0c;
color:#eaeaea;
font-weight:700;
}
.status.done{ color: var(--ok); border-color:#235a23; }
.status.cancelled{ color: var(--danger); border-color:#5a2222; }
.status.delayed{ color: var(--warn); border-color:#5a4a22; }
.status.ontime{ color: var(--ok); border-color:#235a23; }

.footer{
display:flex;
justify-content:space-between;
padding: 12px 16px;
border-top:1px solid #2b2b2b;
color: var(--muted);
font-size: 12px;
background:#0c0c0c;
border-radius: 0 0 14px 14px;
}

.error{
padding: 12px 16px;
color: #ffb3b3;
border-top:1px solid #2b2b2b;
background:#140808;
font-size: 14px;
display:none;
white-space:pre-wrap;
}

/* ===== ADS SIN RECORTE ===== */
#adScreen{
position: fixed;
inset: 0;
background: #000;
display: none;
z-index: 9999;
}
#adScreen img{
width: 100vw;
height: 100vh;
object-fit: contain;
object-position: center;
background: #000;
}
</style>
</head>

<body>
<!-- Pantalla 1 -->
<div id="boardScreen">
<div class="wrap">
<div class="header">
<div class="title">
<div class="badge">ℹ</div>
<div>INFO BOARD</div>
</div>
        <button id="btnFs" class="fsbtn" type="button" aria-label="Pantalla completa" title="Pantalla completa">⛶</button>
<div class="meta">
<div id="now"></div>
<div>Auto-refresh: <span id="refreshEvery"></span>s</div>
</div>
</div>

<!-- PROYECTOS -->
<div class="board first">
<div class="sectionTitle">PROYECTOS</div>
<table class="compact">
<thead>
<tr>
<th style="width:140px;">FECHA</th>
<th>INSTITUCION</th>
<th>PROGRAMAS</th>
<th style="width:140px;">PROYECTOS</th>
<th style="width:170px;">ESTADO</th>
</tr>
</thead>
<tbody id="rowsProjects"></tbody>
</table>
<div id="errProjects" class="error"></div>
</div>

<!-- VUELOS -->
<div class="board" style="margin-top:14px;">
<div class="sectionTitle">VUELOS</div>
<table>
<thead>
<tr>
<th style="width:140px;">FECHA</th>
<th style="width:220px;">VUELO</th>
<th>DESTINO</th>
<th style="width:190px;">HORA DE SALIDA</th>
<th style="width:160px;">DURACION</th>
</tr>
</thead>
<tbody id="rowsFlights"></tbody>
</table>

<div class="footer">
<div>Last update: <span id="lastUpdate">—</span></div>
<div>
Proyectos: <span id="countProjects">0</span> |
Vuelos: <span id="countFlights">0</span>
</div>
</div>

<div id="errFlights" class="error"></div>
</div>
</div>
</div>

<!-- ADS -->
<div id="adScreen">
<img id="adImage" alt="Publicidad" />
</div>

<script>
// ✅ LINKS CSV CORRECTOS (NO uses /edit?...)
const PROJECTS_CSV_URL =
"https://docs.google.com/spreadsheets/d/1O1KoL8mdSwMl-GxOLaUO_QX6HFfbsOw9ghU3lZDzOOM/gviz/tq?tqx=out:csv&gid=0";

const FLIGHTS_CSV_URL =
"https://docs.google.com/spreadsheets/d/1O1KoL8mdSwMl-GxOLaUO_QX6HFfbsOw9ghU3lZDzOOM/gviz/tq?tqx=out:csv&gid=42084063";

const REFRESH_SECONDS = 30;
document.getElementById("refreshEvery").textContent = REFRESH_SECONDS;

const rowsProjects = document.getElementById("rowsProjects");
const rowsFlights  = document.getElementById("rowsFlights");
const errProjects  = document.getElementById("errProjects");
const errFlights   = document.getElementById("errFlights");
const elLast       = document.getElementById("lastUpdate");
const countProjects= document.getElementById("countProjects");
const countFlights = document.getElementById("countFlights");

function tickClock(){
const d = new Date();
document.getElementById("now").textContent =
d.toLocaleString(undefined, {
weekday:"short", year:"numeric", month:"short", day:"2-digit",
hour:"2-digit", minute:"2-digit"
});
}
setInterval(tickClock, 1000);
tickClock();

function safe(v){ return (v ?? "").toString().trim(); }

function normHeader(h){
return safe(h)
.toLowerCase()
.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
.replace(/[^a-z0-9]+/g, "_")
.replace(/^_+|_+$/g, "");
}

function parseCSV(text){
const rows = [];
let row = [], cur = "", inQuotes = false;

for (let i=0; i<text.length; i++){
const ch = text[i];
const next = text[i+1];

if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; }
else if (ch === '"'){ inQuotes = !inQuotes; }
else if (ch === ',' && !inQuotes){ row.push(cur); cur = ""; }
else if ((ch === '\n' || ch === '\r') && !inQuotes){
if (cur.length || row.length){
row.push(cur); cur = "";
if (ch === '\r' && next === '\n') i++;
rows.push(row);
row = [];
}
} else cur += ch;
}
if (cur.length || row.length){ row.push(cur); rows.push(row); }
return rows;
}

async function loadCSV(url){
const finalUrl = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
const res = await fetch(finalUrl);
if (!res.ok) throw new Error("No se pudo cargar el CSV: " + res.status);

const text = await res.text();

// ✅ Si Google devuelve HTML, lo detectamos y damos error claro
if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")){
throw new Error(
"Google NO devolvió CSV (devolvió HTML). " +
"Revisa permisos del Sheet o usa 'Publicar en la web'."
);
}

const data = parseCSV(text);
if (!data.length) throw new Error("CSV vacío.");

const headersRaw = data[0];
const headersNorm = headersRaw.map(normHeader);
const rows = data.slice(1).filter(r => r.some(c => safe(c) !== ""));
return { headersRaw, headersNorm, rows };
}

function findIdx(headersNorm, candidates){
for (const c of candidates){
const i = headersNorm.indexOf(c);
if (i !== -1) return i;
}
return -1;
}

function requireIdx(headersNorm, candidates, label, headersRaw){
const i = findIdx(headersNorm, candidates);
if (i === -1){
throw new Error(
`${label}: encabezado no encontrado.\n` +
`Busqué: ${candidates.join(", ")}\n` +
`Encabezados detectados: ${headersRaw.join(" | ")}`
);
}
return i;
}

function statusPill(txt){
const t = safe(txt).toUpperCase();
if (t.includes("COMPLET")) return `<span class="status done">${t}</span>`;
if (t.includes("CANCEL")) return `<span class="status cancelled">${t}</span>`;
if (t.includes("DELAY")) return `<span class="status delayed">${t}</span>`;
if (t.includes("ON TIME") || t.includes("ONTIME")) return `<span class="status ontime">${t}</span>`;
return `<span class="status">${t || "—"}</span>`;
}

function renderProjects(headersNorm, headersRaw, rows){
errProjects.style.display = "none";
rowsProjects.innerHTML = "";

const iFecha = requireIdx(headersNorm, ["fecha","date"], "PROYECTOS/FECHA", headersRaw);
const iInst  = requireIdx(headersNorm, ["institucion","institution"], "PROYECTOS/INSTITUCION", headersRaw);
const iProg  = requireIdx(headersNorm, ["programas","programa","programs"], "PROYECTOS/PROGRAMAS", headersRaw);
const iProy  = requireIdx(headersNorm, ["proyectos","proyecto","projects","project"], "PROYECTOS/PROYECTOS", headersRaw);
const iEst   = requireIdx(headersNorm, ["estado","status"], "PROYECTOS/ESTADO", headersRaw);

for (const r of rows){
const tr = document.createElement("tr");
tr.innerHTML = `
         <td>${safe(r[iFecha]) || "—"}</td>
         <td>${safe(r[iInst]) || "—"}</td>
         <td>${safe(r[iProg]) || "—"}</td>
         <td>${safe(r[iProy]) || "—"}</td>
         <td>${statusPill(r[iEst])}</td>
       `;
rowsProjects.appendChild(tr);
}
countProjects.textContent = rows.length;
}

function renderFlights(headersNorm, headersRaw, rows){
errFlights.style.display = "none";
rowsFlights.innerHTML = "";

const iFecha = requireIdx(headersNorm, ["fecha","date"], "VUELOS/FECHA", headersRaw);
const iVuelo = requireIdx(headersNorm, ["vuelo","flight"], "VUELOS/VUELO", headersRaw);
const iDest  = requireIdx(headersNorm, ["destino","destination"], "VUELOS/DESTINO", headersRaw);
const iHora  = requireIdx(headersNorm, ["hora_de_salida","hora_salida","hora","std","time"], "VUELOS/HORA DE SALIDA", headersRaw);
const iDur   = requireIdx(headersNorm, ["duracion","duration"], "VUELOS/DURACION", headersRaw);

rows.sort((a,b) => {
const da = safe(a[iFecha]);
const db = safe(b[iFecha]);
if (da !== db) return da.localeCompare(db);
return safe(a[iHora]).localeCompare(safe(b[iHora]));
});

for (const r of rows){
const tr = document.createElement("tr");
tr.innerHTML = `
         <td>${safe(r[iFecha]) || "—"}</td>
         <td>${safe(r[iVuelo]) || "—"}</td>
         <td>${safe(r[iDest]) || "—"}</td>
         <td>${safe(r[iHora]) || "—"}</td>
         <td>${safe(r[iDur]) || "—"}</td>
       `;
rowsFlights.appendChild(tr);
}
countFlights.textContent = rows.length;
}

async function loadAll(){
// PROYECTOS
try{
const p = await loadCSV(PROJECTS_CSV_URL);
renderProjects(p.headersNorm, p.headersRaw, p.rows);
} catch(e){
rowsProjects.innerHTML = "";
countProjects.textContent = "0";
errProjects.textContent = "Error: " + (e?.message || e);
errProjects.style.display = "block";
}

// VUELOS
try{
const f = await loadCSV(FLIGHTS_CSV_URL);
renderFlights(f.headersNorm, f.headersRaw, f.rows);
} catch(e){
rowsFlights.innerHTML = "";
countFlights.textContent = "0";
errFlights.textContent = "Error: " + (e?.message || e);
errFlights.style.display = "block";
}

elLast.textContent = new Date().toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit", second:"2-digit"});
}

// ===== CARRUSEL =====
const boardScreen = document.getElementById("boardScreen");
const adScreen = document.getElementById("adScreen");
const adImage = document.getElementById("adImage");

const playlist = [
{ type: "board", duration: 30000 },
{ type: "ad", src: "ads/ad1.jpg", duration: 10000 },
{ type: "ad", src: "ads/ad2.jpg", duration: 10000 },
];

let current = 0;
let timer = null;

function showBoard(){
adScreen.style.display = "none";
boardScreen.style.display = "block";
}
function showAd(src){
boardScreen.style.display = "none";
adScreen.style.display = "block";
adImage.src = src;
}
function runPlaylist(){
if (timer) clearTimeout(timer);
const item = playlist[current];
if (item.type === "board") showBoard();
else showAd(item.src);

timer = setTimeout(() => {
current = (current + 1) % playlist.length;
runPlaylist();
}, item.duration);
}

const btnFs = document.getElementById("btnFs");

function isFullscreen(){
  return document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.msFullscreenElement;
}

function requestFs(el){
  if (el.requestFullscreen) return el.requestFullscreen();
  if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
  if (el.msRequestFullscreen) return el.msRequestFullscreen();
  return Promise.reject(new Error("Fullscreen no soportado"));
}

function exitFs(){
  if (document.exitFullscreen) return document.exitFullscreen();
  if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
  if (document.msExitFullscreen) return document.msExitFullscreen();
}

/* ✅ actualiza ícono + discreción */
function updateFsBtn(){
  const fs = !!isFullscreen();
  document.body.classList.toggle("is-fs", fs);

  // Solo icono (sin texto)
  btnFs.textContent = fs ? "⤡" : "⛶";

  const label = fs ? "Salir de pantalla completa" : "Pantalla completa";
  btnFs.setAttribute("aria-label", label);
  btnFs.title = label;
}

btnFs?.addEventListener("click", async () => {
  try{
    if (!isFullscreen()) await requestFs(document.documentElement);
    else await exitFs();
    updateFsBtn();
  } catch(e){
    alert("Tu navegador/TV no soporta pantalla completa desde la página.");
  }
});

document.addEventListener("fullscreenchange", updateFsBtn);
document.addEventListener("webkitfullscreenchange", updateFsBtn);
document.addEventListener("msfullscreenchange", updateFsBtn);
updateFsBtn();

// ARRANQUE
loadAll();
setInterval(loadAll, REFRESH_SECONDS * 1000);
runPlaylist();
</script>
</body>
</html>
